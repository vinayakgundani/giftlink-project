<!DOCTYPE html>
<html>
<head>
  <title>Gifts</title>
  <link rel="stylesheet" href="/style.css">

  <style>
    .gift-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      max-width: 1200px;
      margin: 20px auto;
      padding: 10px;
    }
    .gift-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }
    .add-card {
      background: #e8f4ff;
      padding: 20px;
      margin: 20px auto;
      max-width: 450px;
      border-radius: 10px;
      display: none;
    }
    .search-card {
      background: #f1f1f1;
      padding: 15px;
      margin: 20px auto;
      max-width: 450px;
      border-radius: 10px;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px;
      background: #007bff;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
    }
  </style>
</head>

<body>

<%- include("partials/navbar") %>

<h2 style="text-align:center;">Available Gifts</h2>

<div class="search-card">
  <input id="searchCategory" placeholder="Enter category">
  <button onclick="searchGifts()">Search</button>
</div>

<div class="add-card" id="addGiftSection">
  <input id="giftTitle" placeholder="Title">
  <input id="giftCategory" placeholder="Category">
  <input id="giftPrice" type="number" placeholder="Price">
  <textarea id="giftDescription" placeholder="Description"></textarea>
  <button onclick="addGift()">Add Gift</button>
  <p id="addMsg"></p>
</div>

<div id="giftList" class="gift-grid">
  <% if (gifts.length === 0) { %>
    <p>No gifts available.</p>
  <% } %>

  <% gifts.forEach(gift => { %>
    <div class="gift-card">
      <h3><%= gift.title %></h3>
      <p><b>Category:</b> <%= gift.category %></p>
      <p><b>Price:</b> ₹<%= gift.price %></p>
      <p><%= gift.description %></p>
    </div>
  <% }) %>
</div>

<script>
const API = window.location.origin;

// show add gift only if logged in
const token = localStorage.getItem("token");
if (token && token.startsWith("ey")) {
  document.getElementById("addGiftSection").style.display = "block";
}

async function searchGifts() {
  const category = searchCategory.value.trim();
  if (!category) return;

  const res = await fetch(`${API}/api/search?category=${category}`);
  const gifts = await res.json();

  giftList.innerHTML = "";
  gifts.forEach(gift => {
    giftList.innerHTML += `
      <div class="gift-card">
        <h3>${gift.title}</h3>
        <p>${gift.category}</p>
        <p>₹${gift.price}</p>
        <p>${gift.description}</p>
      </div>`;
  });
}

async function addGift() {
  const res = await fetch(`${API}/api/gifts`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({
      title: giftTitle.value,
      category: giftCategory.value,
      price: giftPrice.value,
      description: giftDescription.value
    })
  });

  if (res.ok) location.reload();
  else addMsg.innerText = "Error adding gift";
}
</script>

</body>
</html>
